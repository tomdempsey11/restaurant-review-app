<%- include('../partials/header', { title, user }) %>

<section class="container" style="max-width:720px;margin:32px auto;">
  <h2>Write a Review</h2>
  <p id="rname" style="color:#555;"></p>

  <form id="reviewForm" style="display:grid; gap:12px; max-width:560px;">
    <label>
      Rating (1â€“5)
      <input type="number" name="rating" id="rating" min="1" max="5" required>
    </label>

    <label>
      Title (optional)
      <input type="text" name="title" id="title" maxlength="120">
    </label>

    <label>
      Review
      <textarea name="body" id="body" rows="5" required></textarea>
    </label>

    <button class="btn btn-success" type="submit">Submit Review</button>
    <a class="btn" href="/restaurants/<%= slug %>">Cancel</a>
  </form>

  <p id="msg" style="margin-top:12px;"></p>
</section>

<script>
  const slug = "<%= slug %>";
  const form = document.getElementById('reviewForm');
  const msg  = document.getElementById('msg');
  const rname= document.getElementById('rname');
  let restaurantId = null;

  // Load restaurant to get its _id
  (async function loadRestaurant() {
    try {
      const res = await fetch(`/api/restaurants/${encodeURIComponent(slug)}`, { credentials: 'include' });
      if (!res.ok) throw new Error('Restaurant not found');
      const data = await res.json();
      const r = data.restaurant || data;
      restaurantId = r._id;
      rname.textContent = r.name ? `for ${r.name}` : '';
    } catch (err) {
      console.error(err);
      msg.textContent = 'Unable to load restaurant.';
      msg.style.color = '#b91c1c';
      form.style.display = 'none';
    }
  })();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    msg.textContent = '';
    if (!restaurantId) return;

    const payload = {
      rating: Number(document.getElementById('rating').value),
      title:  document.getElementById('title').value.trim(),
      body:   document.getElementById('body').value.trim(),
    };

    try {
      const res = await fetch(`/api/reviews/${restaurantId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify(payload),
      });
      if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error || 'Failed to submit review');
      }
      // back to details
      window.location.href = `/restaurants/${slug}`;
    } catch (err) {
      console.error(err);
      msg.textContent = err.message;
      msg.style.color = '#b91c1c';
    }
  });
</script>

<%- include('../partials/footer') %>
