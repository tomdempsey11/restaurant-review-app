<%- include('../partials/header', { title, user }) %>

<section class="container" style="max-width:820px;margin:32px auto;">
  <div id="card">Loading…</div>
  <div style="margin-top:16px;">
    <a id="writeLink" class="btn btn-primary" href="#">Write a review</a>
    <a class="btn" href="/restaurants" style="margin-left:8px;">← Back</a>
  </div>
</section>

<script>
  const slug = "<%= slug %>";
  const card = document.getElementById('card');
  const writeLink = document.getElementById('writeLink');
  writeLink.href = `/restaurants/${slug}/reviews/new`;

  (async function () {
    try {
      const res = await fetch(`/api/restaurants/${encodeURIComponent(slug)}`, { credentials: 'include' });
      if (!res.ok) throw new Error('Not found');
      const data = await res.json();
      const r = data.restaurant || data; // accept either shape
      const reviews = data.reviews || [];

      card.innerHTML = `
        <h2 style="margin:0 0 8px 0;">${escapeHtml(r.name)}</h2>
        <div style="color:#555; margin-bottom:12px;">
          ${escapeHtml(r.cuisine || '')}
          ${r.priceRange ? ' • ' + r.priceRange : ''}
        </div>
        <p><strong>Address:</strong> ${escapeHtml(r.address || '—')}</p>
        ${r.description ? `<p><strong>Description:</strong> ${escapeHtml(r.description)}</p>` : ''}
        <h3 style="margin-top:24px;">Reviews</h3>
        ${!reviews.length ? '<p>No reviews yet.</p>' : `
          <ul style="list-style:none; padding:0;">
            ${reviews.map(rv => `
              <li style="border-top:1px solid #eee; padding:12px 0;">
                <div><strong>Rating:</strong> ${'★'.repeat(rv.rating || 0)}${'☆'.repeat(5-(rv.rating||0))}</div>
                ${rv.title ? `<div style="font-weight:600;">${escapeHtml(rv.title)}</div>` : ''}
                <div>${escapeHtml(rv.body || '')}</div>
                <div style="color:#777; font-size:12px; margin-top:4px;">
                  by ${escapeHtml((rv.user && rv.user.name) || 'Anonymous')}
                </div>
              </li>
            `).join('')}
          </ul>
        `}
      `;
    } catch (err) {
      console.error(err);
      card.innerHTML = '<p style="color:#b91c1c;">Restaurant not found.</p>';
    }
  })();

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>

<%- include('../partials/footer') %>
