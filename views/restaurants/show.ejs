<%- include('../partials/header', { title }) %>

<section class="container container--narrow page-section">
  <div id="card" class="card">Loading…</div>

  <div class="row gap-2 mt-4">
    <a id="writeLink" class="btn btn--primary" href="#">Write a review</a>
    <a class="btn btn--ghost" href="/restaurants">← Back</a>
  </div>
</section>

<script>
  const slug = "<%= slug %>";
  const card = document.getElementById('card');
  const writeLink = document.getElementById('writeLink');
  writeLink.href = `/restaurants/${slug}/reviews/new`;

  (async function () {
    try {
      const res = await fetch(`/api/restaurants/${encodeURIComponent(slug)}`, { credentials: 'include' });
      if (!res.ok) throw new Error('Not found');
      const data = await res.json();
      const r = data.restaurant || data; // accept either shape
      const reviews = data.reviews || [];

      card.innerHTML = `
        <h2 class="m-0 mb-2">${escapeHtml(r.name)}</h2>
        <div class="muted mb-3">
          ${escapeHtml(r.cuisine || '')}
          ${r.priceRange ? ' • ' + r.priceRange : ''}
        </div>

        <p><strong>Address:</strong> ${escapeHtml(r.address || '—')}</p>
        ${r.description ? `<p><strong>Description:</strong> ${escapeHtml(r.description)}</p>` : ''}

        <h3 class="mt-6">Reviews</h3>
        ${!reviews.length ? '<p>No reviews yet.</p>' : `
          <ul class="list-unstyled">
            ${reviews.map(rv => `
              <li class="border-top py-3">
                <div><strong>Rating:</strong> <span class="stars">${'★'.repeat(rv.rating || 0)}${'☆'.repeat(5-(rv.rating||0))}</span></div>
                ${rv.title ? `<div class="fw-600">${escapeHtml(rv.title)}</div>` : ''}
                <div>${escapeHtml(rv.body || '')}</div>
                <div class="muted text-sm mt-1">
                  by ${escapeHtml((rv.user && rv.user.name) || 'Anonymous')}
                </div>
              </li>
            `).join('')}
          </ul>
        `}
      `;
    } catch (err) {
      console.error(err);
      card.innerHTML = '<p class="error">Restaurant not found.</p>';
    }
  })();

  function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
</script>

<%- include('../partials/footer') %>
